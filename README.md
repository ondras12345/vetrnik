# vetrnik
Power electronics for heating water using power generated by a small wind
turbine.

![A photograph of the enclosure containing the wind turbine control electronics](docs/img/vetrnik.jpg)


## Features / design goals
- No battery.
- Maximum power point tracking.
- Power to resistive heating elements is AC to prevent electrolytic corrosion.
- MQTT telemetry.
- Home Assistant integration via MQTT.
- Energy meter.
- Calculates RPM from wind turbine AC output frequency.
- Survives full 50 V / 40 A during normal operation, as well as significantly
  higher open-circuit voltage.


The device offers a feature-rich command line interface:
```
vetrnik-control:$ help
---- Available commands ----

SPIflash: Issue commands to SPI flash
conf: Get or set configuration options.
control: Get or set params of control algorithm.
debug: Filter debug messages
dfu: Switch to DFU firmware download mode.
ds18b20: Print out DS18B20 sensor readings
free: Print out amount of free memory.
ifconfig: Print out networking information.
lisp: Process a line of Lisp
lisp_read: Execute Lisp from file
lisp_reset: Reinit Lisp interpreter
log: Print log / postmort
millis: Returns the number of milliseconds passed since the program started.
mqtt: Print out MQTT status.
onewirescan: Scan devices on onewire bus
ota: Switch to over-the-air firmware dl mode.
power: Print status of power PCB or set params.
pump: Control circulation pump.
reset: Reset the MCU.
rx: Print out RX_datapoints.
rx_raw: Toggle printing of messages from power board.
stats: Get stats (energy, ...)
tx: Set value of TX datapoint.
tx_raw: Transmit message to power board.
uptime: Returns the time passed since the program started.
ver: Print out version info.
watch: Run command every second.

vetrnik-control:$ stats
stats:
energy: 0.000 kWh

vetrnik-control:$ power
power board status:
retrieved_millis: 2274816315
valid: 1
time: 56810 s
mode: 2
duty: 0 (0-255)
OCP_max_duty: 255 (0-255)
RPM: 0 RPM
voltage: 0.0 V
current: 0.000 A
enabled.hardware: 1
enabled.software: 1
enabled.overall: 1
emergency: 0
temperature_heatsink: 16.3 'C
temperature_rectifier: 16.4 'C
fan: 0
error_count: 0
last5m: 0

vetrnik-control:$ ds18b20
This command does NOT request a new conversion.
[0] voda: 28.93 C
[1] : 0.00 C
[2] : 0.00 C
[3] : 0.00 C
[4] : 0.00 C
[5] : 0.00 C
[6] : 0.00 C
[7] : 0.00 C
[8] : 0.00 C
[9] : 0.00 C

vetrnik-control:$ SPIflash -h
Usage: SPIflash [erase_chip|ls | create name length erasable | rm name
   | dump name start | dumpchip start | erase filename | ed filename start]

vetrnik-control:$ SPIflash ls
Files:
address (HEX)	name	size (Bytes)
010000	settings	65536
020000	init.lisp	65536

vetrnik-control:$ lisp (= test (/ (+ 1 3) 2))
nil
Success: 1

vetrnik-control:$ lisp test
2
Success: 1

vetrnik-control:$ log
Usage: log (all|new)

vetrnik-control:$ log all
Printing whole log...
---
[      0] event: 0x0D log reinit
[      0] boot: 0x05 POWER-ON_RESET (POR) / POWER-DOWN_RESET (PDR)
[      0] event: 0x00 Eth begin
[      5] event: 0x01 Eth got IP
[      5] control strategy: old=control_shorted new=control_shorted
[      5] MQTT state: -1 DISCONNECTED
[     20] event: 0x03 MQTT connected
[     21] MQTT state: 0 CONNECTED
[   6315] control strategy: old=control_shorted new=control_lisp
[  82610] event: 0x10 DS18B20 error
[ 966931] MQTT state: -3 CONNECTION_LOST
[ 966932] event: 0x03 MQTT connected
[ 966932] MQTT state: 0 CONNECTED
[3386627] MQTT state: -2 CONNECT_FAILED
[3386810] event: 0x03 MQTT connected
[3386810] MQTT state: 0 CONNECTED
[3386870] event: 0x03 MQTT connected
[3387652] MQTT state: -3 CONNECTION_LOST
[3387652] event: 0x03 MQTT connected
[3387652] MQTT state: 0 CONNECTED
[3387712] event: 0x03 MQTT connected
[3387772] MQTT state: -3 CONNECTION_LOST
[3387772] event: 0x03 MQTT connected
[3387772] MQTT state: 0 CONNECTED
[3387814] control strategy: old=control_lisp new=control_shorted
[      0] boot: 0x04 SOFTWARE_RESET
[      0] event: 0x00 Eth begin
[      5] event: 0x01 Eth got IP
[      5] control strategy: old=control_shorted new=control_shorted
[      5] MQTT state: -1 DISCONNECTED
[     20] event: 0x03 MQTT connected
[     20] MQTT state: 0 CONNECTED
[     28] MQTT receive: length=1
[     29] MQTT receive: length=11
[     29] control strategy: old=control_shorted new=control_lisp
[ 118759] MQTT state: -3 CONNECTION_LOST
[ 118760] event: 0x03 MQTT connected
[ 118760] MQTT state: 0 CONNECTED
[ 721373] MQTT state: -3 CONNECTION_LOST
[ 721373] MQTT state: -2 CONNECT_FAILED
[ 721414] event: 0x03 MQTT connected
[ 721414] MQTT state: 0 CONNECTED
[ 982793] MQTT state: -3 CONNECTION_LOST
[ 982794] event: 0x03 MQTT connected
[ 982794] MQTT state: 0 CONNECTED
[ 983379] MQTT state: -3 CONNECTION_LOST
[ 983380] event: 0x03 MQTT connected
[ 983380] MQTT state: 0 CONNECTED
[2274043] MQTT receive: length=1
[2274062] MQTT receive: length=1
done

vetrnik-control:$
```


## Hardware details
See [`hardware/`](hardware/).
